#!/bin/bash

tmpfs=${TMPFS:-/tmp}

default_mode=global
current_mode=$default_mode
mode_file=$tmpfs/qeman_mode
#mode_file=./.qeman-mode

# These are the possible filenames and paths of the config file
config_fn=qeman.setups
local_config_fn=./$config_fn
xdg_config_fn=$XDG_CONFIG_HOME/qeman/$config_fn
home_config_fn=$HOME/.config/qeman/$config_fn
custom_config_fn=$QEMAN_CONFIG_FILE

# This is our config file var
# no default value
qeman_config_file=""

# Source the config parser
source "${0%/*}"/bash-ini-parser

print_setups() {
	if [[ -n $1 && $1 == "-l" ]]; then
		cat $qeman_file | sed 's/^/  /g' | sed 's/  \[/\[/g'
	else
		cat $qeman_file | grep -vP "^[^\[].*[^\]]$" | tr -d "[]"
	fi
}

setup_new() {
	if [[ -z $1 ]]; then
		echo "No name specified"
		exit 1
	fi

	cfg_writer > $qeman_file
	echo "[$1]" >> $qeman_file
	echo "localtime=enable" >> $qeman_file
	parse_config
}

setup_cp() {
	if [[ -z $1 || -z $2 ]]; then
		echo "Not enough arguments"
		exit 1
	fi

	cfg_writer > $qeman_file
	output=$(sed -n -e "/$1\]/,/^\[/{ /$1\]/d; /^\[/d; p; }" qeman.setups)
	if [[ -z $output ]]; then
		echo "Invalid source"
		exit 1
	fi
	echo "Copying $1 to $2"
	echo "[$2]" >> $qeman_file
	echo "$output" >> $qeman_file
	parse_config
}

setup_mv() {
	if [[ -z $1 || -z $2 ]]; then
		echo "Not enough arguments"
		exit 1
	fi

	cfg_writer > $qeman_file
	echo "Moving $1 to $2"
	sed -i "s/$1/$2/g" $qeman_file
	parse_config
}

setup_rm() {
	if ! grep -q "\[$1\]" $qeman_file; then
		echo "Setup not found"
		exit 1
	fi	

	cfg_writer > $qeman_file
	echo "Removing $1"
	sed "/\[$1\]/,"'/\[/{//!d}' $qeman_file | sed "/\[$1\]/d" > $tmpfs/$config_fn
	cp $tmpfs/$config_fn $qeman_file
	rm $tmpfs/$config_fn
	parse_config
}

# Handling the mode commands
if [ "$1" == mode ]; then
	if [ "$2" == local ]; then
		echo local > $mode_file
		echo "qeman mode set to local"
	elif [ "$2" == global ]; then
		echo global > $mode_file
		echo "qeman mode set to global"
	else
		if [ -s $mode_file ]; then
			cat $mode_file
		else
			echo $default_mode > $mode_file
			cat $mode_file
		fi
	fi
	exit 0
fi

# Setting the mode on load
# Default is already set, so set only if the mode file exists
if [ -s $mode_file ]; then
	current_mode=$(cat $mode_file)
fi

# Error checking the mode file
if [ $current_mode != local -a $current_mode != global ]; then
	echo "Invalid mode"
	exit 1
fi

# Read config
if [[ -n $QEMAN_CONFIG_FILE ]]; then
	qeman_file="$QEMAN_CONFIG_FILE"
elif [[ $current_mode == local ]]; then
	qeman_file="$local_config_fn"
elif [[ $current_mode == global && -s $xdg_config_fn ]]; then
	qeman_file="$xdg_config_fn"
elif [[ $current_mode == global && -s $home_config_fn ]]; then
	qeman_file="$home_config_fn"
else
	echo "No qeman file found"
	exit 1
fi

# Parse the config
parse_config() {
	#echo "Parsing config!"
	if ! cfg_parser "$qeman_file" ; then
		echo "error 1"
		exit 1
	fi
}
parse_config


# Command: setup
if [[ $1 == setup ]]; then
	if [[ $2 == new ]]; then
		setup_new $3
	elif [[ $2 == cp ]]; then
		setup_cp $3 $4
	elif [[ $2 == mv ]]; then
		setup_mv $3 $4
	elif [[ $2 == rm ]]; then
		setup_rm $3
	elif [[ $2 == ls ]]; then
		print_setups $3
	else
		echo "Unrecognized command: $2"
	fi
	exit
fi
# End command: setup


# Aliases for setup
if [[ $1 == new ]]; then
	setup_new $2
elif [[ $1 == cp ]]; then
	setup_cp $2 $3
elif [[ $1 == mv ]]; then
	setup_mv $2 $3
elif [[ $1 == rm ]]; then
	setup_rm $2
elif [[ $1 == ls ]]; then
	print_setups $2
else
	echo "Unrecognized alias: $2"
	if [[ $1 == add ]]; then
		echo "Did you mean 'new'?"
	fi
fi
exit
# End aliases for setup
