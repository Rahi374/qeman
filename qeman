#!/bin/bash

tmpfs=${TMPFS:-/tmp}

default_mode=global
current_mode=$default_mode
mode_file=$tmpfs/qeman_mode
#mode_file=./.qeman-mode

# These are the possible filenames and paths of the config file
config_fn=qeman.setups
local_config_fn=./$config_fn
xdg_config_fn=$XDG_CONFIG_HOME/qeman/$config_fn
home_config_fn=$HOME/.config/qeman/$config_fn
custom_config_fn=$QEMAN_CONFIG_FILE

# This is our config file var
# no default value
qeman_config_file=""

# Source the config parser
source "${0%/*}"/bash-ini-parser

print_setups() {
	setups=$(compgen -A function | grep cfg_section | sed 's/cfg_section_//g')
	for i in $setups ; do
		echo "[$i]"
		cfg_unset
		cfg_section_$i
		if [[ -n $hda ]]; then
			echo "  hda = $hda"; fi
		if [[ -n $hdb ]]; then
			echo "  hdb = $hdb"; fi
		if [[ -n $hdc ]]; then
			echo "  hdc = $hdc"; fi
		if [[ -n $hdd ]]; then
			echo "  hdd = $hdd"; fi
		if [[ -n $hde ]]; then
			echo "  hde = $hde"; fi
		if [[ -n $cd ]]; then
			echo "  cd = $cd"; fi
		if [[ -n $portfwd ]]; then
			echo "  portfwd = $portfwd"; fi
		if [[ -n $mem ]]; then
			echo "  mem = $mem"; fi

		if [[ -z $localtime ]]; then
			echo "  localtime = disable"
		else
			echo "  localtime = $localtime"
		fi

		if [[ -z $kvm ]]; then
			echo "  kvm = disable"
		else
			echo "  kvm = $kvm"
		fi

		if [[ -z $boot_from_disk ]]; then
			echo "  boot_from_disk = disable"
		else
			echo "  boot_from_disk = $boot_from_disk"
		fi

		if [[ -n $arch ]]; then
			echo "  arch = $arch"; fi
	done
}

setup_new() {
	if [[ -z $1 ]]; then
		echo "No name specified"
		exit 1
	fi

	cfg_writer > $qeman_file
	echo "[$1]" >> $qeman_file
	echo "localtime=enable" >> $qeman_file
	parse_config
}

setup_cp() {
	if [[ -z $1 || -z $2 ]]; then
		echo "Not enough arguments"
		exit 1
	fi

	cfg_writer > $qeman_file
	output=$(sed -n -e "/$1\]/,/^\[/{ /$1\]/d; /^\[/d; p; }" qeman.setups)
	if [[ -z $output ]]; then
		echo "Invalid source"
		exit 1
	fi
	echo "Copying $1 to $2"
	echo "[$2]" >> $qeman_file
	echo "$output" >> $qeman_file
	parse_config
}

setup_mv() {
	if [[ -z $1 || -z $2 ]]; then
		echo "Not enough arguments"
		exit 1
	fi

	cfg_writer > $qeman_file
	echo "Moving $1 to $2"
	sed -i "s/$1/$2/g" $qeman_file
	parse_config
}

setup_rm() {
	if ! grep -q "\[$1\]" $qeman_file; then
		echo "Setup not found"
		exit 1
	fi	

	cfg_writer > $qeman_file
	# TODO: implement rm
	parse_config
}

# Handling the mode commands
if [ "$1" == mode ]; then
	if [ "$2" == local ]; then
		echo local > $mode_file
		echo "qeman mode set to local"
	elif [ "$2" == global ]; then
		echo global > $mode_file
		echo "qeman mode set to global"
	else
		if [ -s $mode_file ]; then
			cat $mode_file
		else
			echo $default_mode > $mode_file
			cat $mode_file
		fi
	fi
	exit 0
fi

# Setting the mode on load
# Default is already set, so set only if the mode file exists
if [ -s $mode_file ]; then
	current_mode=$(cat $mode_file)
fi

# Error checking the mode file
if [ $current_mode != local -a $current_mode != global ]; then
	echo "Invalid mode"
	exit 1
fi

# Read config
if [[ -n $QEMAN_CONFIG_FILE ]]; then
	qeman_file="$QEMAN_CONFIG_FILE"
elif [[ $current_mode == local ]]; then
	qeman_file="$local_config_fn"
elif [[ $current_mode == global && -s $xdg_config_fn ]]; then
	qeman_file="$xdg_config_fn"
elif [[ $current_mode == global && -s $home_config_fn ]]; then
	qeman_file="$home_config_fn"
else
	echo "No qeman file found"
	exit 1
fi

# Parse the config
parse_config() {
	#echo "Parsing config!"
	if ! cfg_parser "$qeman_file" ; then
		echo "error 1"
		exit 1
	fi
}
parse_config


# Command: setup
if [[ $1 == setup ]]; then
	if [[ $2 == new ]]; then
		setup_new $3
	elif [[ $2 == cp ]]; then
		setup_cp $3 $4
	elif [[ $2 == mv ]]; then
		setup_mv $3 $4
	elif [[ $2 == rm ]]; then
		setup_rm $3
	elif [[ $2 == ls ]]; then
		print_setups
	else
		echo "Unrecognized command: $2"
	fi
fi
# End command: setup
